<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Locals</title>
<meta name="description" content="Profili Local per Milano e Roma. Sblocca la mappa inserendo la tua email.">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
<style>
:root{
  --bg:#f7f7fa; --text:#1b1b24; --muted:#676a7e;
  --accent:#7c7aac; --accent2:#a29fe2;
  --border:#e3e4ef; --card:#ffffff;
  --shadow:rgba(124,122,172,0.1);
}
*{box-sizing:border-box}
body{
  margin:0; background:var(--bg); color:var(--text);
  font:16px/1.6 "Inter", system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, sans-serif;
}

/* Container */
.container{max-width:1100px;margin:auto;padding:32px 24px}

/* Header */
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:32px;}
.header img{height:52px;filter:drop-shadow(0 2px 4px var(--shadow));}
.badge{border:1px solid var(--border);background:linear-gradient(135deg,var(--accent2)10%,var(--accent)90%);
color:#fff;padding:6px 14px;border-radius:999px;font-size:13px;font-weight:600;letter-spacing:.2px;}

/* Hero */
.hero{text-align:center;margin:32px 0;}
.hero h1{margin:0 0 10px;font-size:34px;font-weight:800;color:var(--accent);
background:linear-gradient(90deg,var(--accent),var(--accent2));
-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.hero p{margin:0 auto;color:var(--muted);max-width:720px;font-size:17px;}

/* Section titles */
.section-title{margin:26px 0 14px;font-size:21px;font-weight:700;color:var(--accent);}

/* Cards */
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:20px;}
.card{background:var(--card);border:1px solid var(--border);border-radius:18px;overflow:hidden;cursor:pointer;
box-shadow:0 4px 8px var(--shadow);transition:transform .15s ease, box-shadow .15s ease;position:relative;}
.card:hover{transform:translateY(-3px);box-shadow:0 10px 22px rgba(124,122,172,0.15);}
.cover{width:100%;height:220px;object-fit:cover;display:block}
.card-body{padding:14px 16px}
.name{font-weight:700;margin:0 0 4px;font-size:17px}
.subtitle{color:var(--muted);font-size:13.5px;margin:0 0 10px}
.chips{display:flex;flex-wrap:wrap;gap:6px}
.pill{background:#f0efff;border:1px solid #e3e1ff;color:#3c3a6a;padding:5px 9px;border-radius:999px;font-size:11.5px}
.rating{user-select:none;line-height:1;margin-bottom:6px;}

/* Price badge */
.price-badge{
  position:absolute;top:10px;right:10px;
  background:linear-gradient(90deg,var(--accent),var(--accent2));
  color:#fff;padding:4px 10px;border-radius:999px;font-weight:600;font-size:13px;
}

/* Modal */
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);
display:none;place-items:center;z-index:1000;}
.modal{width:min(760px,96%);background:#fff;border-radius:16px;overflow:hidden;
display:flex;flex-direction:column;max-height:90vh;}
.modal-head{padding:12px 16px;border-bottom:1px solid var(--border);
display:flex;justify-content:space-between;align-items:center;background:#f4f3ff;}
.modal-title{font-weight:800}.modal-sub{font-size:12.5px;color:#6a6f82}
.close{cursor:pointer;font-size:18px;border:none;background:none;color:#666;line-height:1}
.close:hover{color:var(--accent)}
.modal-body{
  padding:14px 16px;
  overflow-y:visible;
  max-height:none;
}
.modal img{width:100%;height:220px;border-radius:12px;object-fit:cover}
.about{margin:10px 0 10px}
.keywords{display:flex;flex-wrap:wrap;gap:8px;margin:6px 0 10px}
.keyword{padding:6px 10px;border-radius:999px;border:1px solid var(--border);
background:#fafaff;font-size:12.5px;cursor:pointer}
.keyword.active{background:var(--accent);color:#fff;border-color:var(--accent)}
.form{display:grid;grid-template-columns:1fr auto auto;gap:8px;align-items:center;margin:8px 0 0}
input[type=email]{padding:9px 10px;border:1px solid var(--border);
border-radius:10px;font-size:14.5px;width:100%}
.btn{padding:10px 12px;border-radius:10px;font-weight:700;cursor:pointer}
.btn-primary{background:linear-gradient(90deg,var(--accent),var(--accent2));border:none;color:#fff}
.btn--disabled {
  opacity: 0.55;
  cursor: not-allowed;
  box-shadow: none;
  transform: none;
  pointer-events: auto;
}
#map{height:360px;border-radius:12px;border:1px solid var(--border)}

/* iOS Safari + Leaflet: evita shrink dei tile e forza compositing */
.leaflet-container img { max-width: none !important; }
#map { will-change: transform; transform: translateZ(0); }

/* Place info */
#placeInfo{
  width:100%;background:#fff;border:1px solid var(--border);
  border-radius:12px;padding:12px;display:none;margin-top:12px;
}
#placeInfo h4{margin:0 0 6px;}
#placeInfo .close-info{cursor:pointer;font-size:14px;color:#666;text-align:right;margin-bottom:6px;}
#placeInfo .close-info:hover{color:var(--accent);}

/* Chat controls */
#chatControls{display:flex;gap:10px;align-items:center;margin-top:10px;flex-wrap:wrap;}
#chatCounter{font-weight:700;padding:4px 10px;border-radius:12px;background:#f0efff;}
#buyChatBtn{padding:4px 10px;border-radius:12px;border:none;
background:linear-gradient(90deg,var(--accent),var(--accent2));color:#fff;cursor:pointer;font-weight:600;}

/* Responsive */
@media (max-width: 768px) {
  .container{padding:20px 16px}
  .header img{height:42px}
  .badge{padding:4px 10px;font-size:12px}
  .hero h1{font-size:26px}
  .hero p{font-size:15px;max-width:90%}
  .section-title{font-size:18px;margin:18px 0 10px}

  /* cards / layout */
  .card{border-radius:14px}
  .card-body{padding:10px 12px}
  .name{font-size:15.5px}
  .subtitle{font-size:12.5px}
  .pill{font-size:11px;padding:4px 8px}

  /* modal adjustments che aiutano il rendering map su iOS */
  .modal{width:94%;max-height:88vh;border-radius:14px}
  .modal-body{overflow:auto;-webkit-overflow-scrolling:touch} /* perf for iOS */
  .modal img{height:180px;display:block}
  .form{grid-template-columns:1fr;gap:6px}
  .btn-primary{width:100%}

  /* map: altezza esplicita (important per sicurezza) */
  #map{height:280px !important;border-radius:12px;border:1px solid var(--border)}

  /* üîπ Contatori centrali e orizzontali su mobile */
  #globalCounters {
    position: relative;          /* NON fixed: evita problemi iOS con compositing */
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: row;
    gap: 10px;
    background: transparent;
    padding: 8px 0;
    margin-top: 8px;
    z-index: 1;
  }
  #globalCounters > div,
  #openPlansBtn {
    background: #fff;
    border: 1px solid var(--border);
    border-radius: 999px;
    padding: 6px 12px;
    font-size: 13px;
    font-weight: 600;
    color: var(--accent);
    box-shadow: 0 2px 6px rgba(0,0,0,0.06);
  }
  #openPlansBtn {
    background: linear-gradient(90deg,var(--accent),var(--accent2));
    color: #fff;
    cursor: pointer;
  }

  .header { margin-top: 0; }
}

/* extra for very small screens */
@media (max-width:480px){
  .hero h1{font-size:22px}
  .hero p{font-size:14.5px}
  .badge{display:none}
}

/* üîß Fix layout mobile place info & form */
@media (max-width:768px) {
  #placeInfo {
    padding: 10px;
    font-size: 14px;
  }

  #placeInfo h4 {
    font-size: 15px;
    margin-bottom: 4px;
  }

  #placeInfo div[style*="display:flex;justify-content:space-between"] {
    flex-direction: column;
    align-items: flex-start;
  }

  #placeInfo a#placeGoogle {
    width: 100%;
    margin: 10px 0 0 0 !important;
    text-align: center;
    font-size: 14px;
    padding: 10px 0;
  }

  /* Fix "nessun addebito" + prezzo */
  #unlockForm {
    align-items: stretch !important;
  }
  #unlockForm > div {
    width: 100%;
  }
  #priceInfo {
    display: inline-block;
    font-size: 15px;
  }

  /* Form e bottoni pi√π compatti */
  .form {
    gap: 8px;
  }
  .form button {
    width: 100%;
  }
}
</style>
</head>
<body>
<div id="globalCounters" style="
  position:fixed;top:16px;right:16px;z-index:300;
  display:flex;flex-direction:column;gap:8px;
  align-items:flex-end;">
  
  <div id="mapCounter" style="
    background:#fff;border:1px solid var(--border);
    border-radius:12px;padding:6px 12px;
    box-shadow:0 4px 10px rgba(0,0,0,0.1);
    font-size:14px;font-weight:600;color:var(--accent);">
    üîì Mappe: 1
  </div>
  
  <div id="chatGlobalCounter" style="
    background:#fff;border:1px solid var(--border);
    border-radius:12px;padding:6px 12px;
    box-shadow:0 4px 10px rgba(0,0,0,0.1);
    font-size:14px;font-weight:600;color:var(--accent);">
    üí¨ Chat: 1
  </div>

  <button id="openPlansBtn" onclick="openSubscriptionModal()" 
    style="
        background:linear-gradient(90deg,#ffb347,#ff7b00);
        color:#fff;
        border:none;
        padding:6px 12px; /* uguale ai contatori */
        border-radius:12px; /* stesso raggio */
        font-weight:600;
        font-size:14px;
        box-shadow:0 4px 10px rgba(0,0,0,0.1);
        cursor:pointer;
        margin-top:6px;
        align-self:flex-end;
        transition:transform .2s ease;">
      üí° Piani
  </button>
</div>

<div class="container">
  <header class="header">
    <div style="display:flex;align-items:center;gap:10px">
      <img src="logo.png" alt="Locals">
    </div>
    <div class="badge">MVP di validazione</div>
  </header>

  <section class="hero">
    <h1>Scopri le citt√† con gli occhi di chi le vive</h1>
    <p>Ogni mappa √® curata da un Local: una persona che conosce davvero la sua citt√†.<br>
    Sblocca un profilo per scoprire i posti pi√π autentici.<br>
    Dopo aver esplorato la mappa, apparir√† anche un breve form per lasciare il tuo feedback!</p>
  </section>

  <section id="cards"></section>

  <footer class="footer" style="margin-top:24px;color:#8a93a8;font-size:12.5px;text-align:center">
    ¬© Locals ‚Äì MVP
  </footer>
</div>

<!-- Modal -->
<div id="modal" class="modal-backdrop" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="modal-head">
      <div>
        <div id="modalTitle" class="modal-title"></div>
        <div id="modalSubtitle" class="modal-sub"></div>
      </div>
      <button id="modalClose" class="close" aria-label="Chiudi">‚úï</button>
    </div>

    <div class="modal-body">
      <img id="modalCover" src="" alt="" loading="lazy">
      <p id="modalAbout" class="about"></p>
      <div id="keywords" class="keywords"></div>
      <form id="unlockForm" class="form" style="align-items:flex-start;">
        <input id="email" type="email" placeholder="La tua email per sbloccare la mappa" required>
      
        <div style="display:flex;flex-direction:column;align-items:flex-start;gap:4px;">
          <div style="display:flex;align-items:center;gap:8px;">
            <button type="submit" id="btnUnlock" class="btn btn-primary">Sblocca mappa</button>
            <span id="priceInfo" style="font-weight:600;color:var(--accent);font-size:15px;">
              0‚Ç¨
            </span>
          </div>
          <div style="font-size:13px;color:#444;font-weight:600;margin-top:4px;">
            * Nessun addebito reale
          </div>
        </div>
      </form>

      <div id="chatControls" style="display:none;margin-top:16px;width:100%;">
        <button id="startChat" class="btn btn-primary" style="width:100%;">Avvia chat</button>
      </div>

      <div id="mapWrap" class="map-wrap" style="display:flex;flex-direction:column;gap:14px;align-items:flex-start">
        <div id="map" style="width:100%"></div>
        <aside id="placeInfo"
          style="width:100%;background:#fff;border:1px solid var(--border);
          border-radius:12px;padding:14px;display:none;margin-top:12px;
          box-shadow:0 4px 10px rgba(0,0,0,0.05);">
          
          <div style="display:flex;justify-content:space-between;align-items:flex-start;">
            <div>
              <h4 id="placeTitle" style="margin:0;"></h4>
              <div id="placeType" style="font-size:13px;color:var(--muted);margin-bottom:8px"></div>
              <div id="placeDesc" style="font-size:14px;color:var(--text);"></div>
            </div>
            <a id="placeGoogle" target="_blank" rel="noopener noreferrer"
               class="btn"
               style="text-decoration:none;padding:8px 10px;margin-left:12px;border-radius:8px;
               background:#f4f3ff;color:var(--accent);border:1px solid var(--border);white-space:nowrap;">
               Apri su Google Maps
            </a>
          </div>
        
          <div class="close-info" id="closePlaceInfo"
               style="cursor:pointer;font-size:13px;color:#666;text-align:right;margin-top:8px;">‚úï Chiudi</div>
        </aside>
      </div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script>
/* ---------- CONFIG ---------- */
const SUBMIT_ENDPOINT = "https://formspree.io/f/xkgpbznv";
const FEEDBACK_FORM = "https://docs.google.com/forms/d/e/1FAIpQLSf0jr7X3hJ_rl4l2AREPRgW1i06N2Pgr8kg509C50HC2V0wbQ/viewform?usp=header";
const FEEDBACK_DELAY_MS = 10000;

/* ---------- CHAT TOKENS ---------- */
const CHAT_TOKENS_KEY = 'ChatTokens';
if(localStorage.getItem(CHAT_TOKENS_KEY)===null) localStorage.setItem(CHAT_TOKENS_KEY,'1');
function getChatTokens(){ return Number(localStorage.getItem(CHAT_TOKENS_KEY)||1); }
function setChatTokens(n){ localStorage.setItem(CHAT_TOKENS_KEY,String(n)); updateChatUI(); }
  
/* ---------- MAP TOKENS ---------- */
const MAP_TOKENS_KEY = 'MapTokens';
if (localStorage.getItem(MAP_TOKENS_KEY) === null) localStorage.setItem(MAP_TOKENS_KEY, '1');

function getMapTokens() {
  return Number(localStorage.getItem(MAP_TOKENS_KEY) || 1);
}
function setMapTokens(n) {
  localStorage.setItem(MAP_TOKENS_KEY, String(n));
  updateGlobalCounters();
}

/* ---------- SUBSCRIPTION STATE ---------- */
const SUBSCRIPTION_KEY = 'SubscriptionActive';
function hasSubscription(){
  return localStorage.getItem(SUBSCRIPTION_KEY) === 'true';
}
function activateSubscription(){
  localStorage.setItem(SUBSCRIPTION_KEY, 'true');
  updateGlobalCounters();
}
  
/* ---------- COUNTERS UPDATE ---------- */
function updateGlobalCounters() {
  const mapCounter = document.getElementById('mapCounter');
  const chatCounter = document.getElementById('chatGlobalCounter');

  if (hasSubscription()) {
    mapCounter.textContent = "üîì Mappe: ‚àû";
    chatCounter.textContent = "üí¨ Chat: ‚àû";
  } else {
    mapCounter.textContent = `üîì Mappe: ${getMapTokens()}`;
    chatCounter.textContent = `üí¨ Chat: ${getChatTokens()}`;
  }  
}

/* ---------- CHAT UI UPDATE ---------- */
function updateChatUI() {
  const startBtn = document.getElementById('startChat');
  const controls = document.getElementById('chatControls');
  const tokens = getChatTokens();

  if (hasSubscription()) {
    startBtn.classList.remove('btn--disabled');
  } else {
    if (tokens <= 0) {
      startBtn.classList.add('btn--disabled');
    } else {
      startBtn.classList.remove('btn--disabled');
    }
  }

  controls.style.display = 'flex';
  updateGlobalCounters();
}

/* ---------- TRACKING ---------- */
function trackEvent(payload){
  if(!SUBMIT_ENDPOINT) return;
  fetch(SUBMIT_ENDPOINT,{
    method:'POST',headers:{'Content-Type':'application/json'},
    body:JSON.stringify(Object.assign({ts:Date.now()},payload))
  }).catch(()=>{});
}

/* ---------- DATA ---------- */
const imgPath = (name) => `covers/${name}`;
const MAPS = [
  { id:"mi-giulia", city:"Milano", title:"Giulia ‚Äì Foodie & Design", rating: 5.0,
    cover: imgPath("mi-giulia.webp"),
    subtitle:"Product designer e pasticcerie d‚Äôautore",
    about:"Designer appassionata di pasticcerie e spazi curati. Ti guider√≤ tra caff√® artigianali, brunch memorabili e cortili nascosti.",
    keywords:["Foodie","Design","Caff√®","Brunch","Arte"],
    center:[45.463,9.189], price:10,
    poi:[
      {name:"Trippa",type:"Ristorante",coords:[45.4508,9.2054], desc: "Il mio posto preferito per piatti autentici e un‚Äôatmosfera senza fronzoli."},
      {name:"Bar Luce",type:"Caff√®",coords:[45.4516,9.1796], desc: "Firmato Wes Anderson: ogni dettaglio sembra uscito da un film."},
      {name:"Pav√©",type:"Bakery",coords:[45.4773,9.2058], desc: "Croissant e cappuccino perfetti, il mio rituale del sabato mattina."},
      {name:"10 Corso Como",type:"Concept",coords:[45.4848,9.1849]},
      {name:"Isola Murales",type:"Passeggiata",coords:[45.4897,9.1911], desc: "Un percorso colorato tra street art e scorci di quartiere."},
      {name:"Eutopia",type:"Wine Bar",coords:[45.4706,9.2069], desc: "Perfetto per un calice di vino naturale e due chiacchiere tranquille."},
      {name:"Upcycle",type:"Caf√©",coords:[45.4890,9.2276]},
      {name:"Nonostante Marras",type:"Spazio",coords:[45.4746,9.1609], desc: "Un luogo magico, tra arte, moda e un piccolo giardino segreto."},
      {name:"Drogheria Milanese",type:"Bistrot",coords:[45.4648,9.1771]},
      {name:"MAG Caf√©",type:"Cocktail",coords:[45.4513,9.1838]},
      {name:"Pasticceria Grecchi Luigi",type:"Pasticceria",coords:[45.482353,9.166655]},
      {name:"Antica Trattoria Ambrosiana",type:"Trattoria",coords:[45.517264,9.19165]},
      {name:"Latteria Carlon",type:"Latteria",coords:[45.471912,9.203508]},
      {name:"La Belle Aurore",type:"Caff√® Letterario",coords:[45.471893,9.214477]},
      {name:"Trattoria Sabbioneda",type:"Trattoria",coords:[45.480135,9.2088]},
      {name:"Gelateria Umberto",type:"Gelateria",coords:[45.461894,9.206555], desc: "Gelato alla nocciola tra i migliori di Milano!"}
    ]
  },
  { id:"mi-luca", city:"Milano", title:"Luca ‚Äì Tech & Alternative Night", rating: 4.3,
    cover: imgPath("mi-luca.webp"),
    subtitle:"Dev by day, clubber by night",
    about:"Sviluppatore di giorno, clubber di notte. Tra coworking, bar alternativi e club sotterranei: la Milano alternativa.",
    keywords:["Nightlife","Startups","Musica","Cocktail"],
    center:[45.463,9.189], price:8,
    poi:[
      {name:"BASE",type:"Hub",coords:[45.4517,9.1702], desc: "Coworking, mostre e dj set: il mio posto per tutto, dal mattino alla notte."},
      {name:"Tempio del Futuro Perduto",type:"Spazio",coords:[45.4899,9.1802], desc: "Spazio autogestito incredibile: arte, musica e comunit√† vera."},
      {name:"Tunnel Club",type:"Club",coords:[45.4868,9.2018], desc: "Se ami l‚Äôelettronica, questo √® un classico milanese."},
      {name:"FAQ",type:"Club",coords:[45.4653,9.1910]},
      {name:"Le Biciclette",type:"Bar",coords:[45.4616,9.1865]},
      {name:"Spirit de Milan",type:"Club",coords:[45.5185,9.1408], desc: "Balera vintage e birra sotto le luci calde. Energia unica."},
      {name:"NoLo",type:"Quartiere",coords:[45.4970,9.2185]},
      {name:"Bar Nievo",type:"Bar Storico",coords:[45.493969,9.144644]},
      {name:"Zodiaco Bar",type:"Bar",coords:[45.479552,9.183431]},
      {name:"Bar Tabacchi Gallo - Tavola Fredda",type:"Bar di quartiere",coords:[45.500369,9.178446]},
      {name:"Trattoria da Tomaso",type:"Trattoria popolare",coords:[45.485598,9.191453]},
      {name:"Margy Burger",type:"Street food",coords:[45.462339,9.194208]},
      {name:"Bocciofila Martesana Dance",type:"Bocciofila/Spazio sociale",coords:[45.502941,9.219486], desc: "Qui balli, mangi e chiacchieri con chiunque. Spirito milanese vero."},
      {name:"Bar Paperoga",type:"Bar alternativo",coords:[45.464807,9.23002]}
    ]
  },
  { id:"rm-sara", city:"Roma", title:"Sara ‚Äì Classici & Nascosti", rating: 5.0,
    cover: imgPath("rm-sara.webp"),
    subtitle:"Archivista e cortili segreti",
    about:"Archivista e fotografa: ti porter√≤ tra belvederi, giardini e scorci fuori dal circuito turistico.",
    keywords:["Storia","Fotografia","Giardini","Relax"],
    center:[41.9028,12.4964], price:12,
    poi:[
      {name:"Gianicolo",type:"Panorama",coords:[41.8925,12.4612], desc: "Il tramonto pi√π romantico di Roma. Sempre."},
      {name:"Copped√®",type:"Quartiere",coords:[41.9197,12.5116], desc: "Un angolo surreale di Roma, tra liberty e fantasia."},
      {name:"Orto Botanico",type:"Giardino",coords:[41.8938,12.4660], desc: "Silenzio, verde e pace nel cuore di Trastevere."},
      {name:"Mercato Testaccio",type:"Mercato",coords:[41.8778,12.4763]},
      {name:"Via Margutta",type:"Strada",coords:[41.9074,12.4798]},
      {name:"Villa Torlonia",type:"Parco",coords:[41.9142,12.5112]},
      {name:"Sant'Eustachio",type:"Caff√®",coords:[41.8996,12.4761], desc: "Il caff√® pi√π cremoso di Roma, segreto ben custodito dai locali."},
      {name:"Fori Imperiali (alba)",type:"Passeggiata",coords:[41.8923,12.4853]},
      {name:"Giardino degli Aranci",type:"Panorama",coords:[41.8817,12.4792], desc: "Vista mozzafiato sul Tevere, perfetta per staccare tutto."},
    ]
  },
  { id:"rm-davide", city:"Roma", title:"Davide ‚Äì Street Food & Nightlife", rating: 4.2,
    cover: imgPath("rm-davide.webp"),
    subtitle:"Food trucker e nottambulo",
    about:"Appassionato di street food e nightlife: mercati, birre artigianali e piazze vive per serate autentiche.",
    keywords:["Street food","Nightlife","Birre","Aperitivi"],
    center:[41.9028,12.4964], price:10,
    poi:[
      {name:"Trapizzino Testaccio",type:"Street food",coords:[41.8769,12.4769], desc: "Il re dello street food romano. Polpette al sugo nel pane: geniale."},
      {name:"Open Baladin",type:"Birreria",coords:[41.8984,12.4737], desc: "Birre artigianali top e atmosfera easy. Ottimo punto di partenza per la serata."},
      {name:"Drink Kong",type:"Cocktail",coords:[41.9000,12.4797], desc: "Cocktail bar futuristico e super curato. Non sembra neanche Roma."},
      {name:"Pigneto",type:"Quartiere",coords:[41.8895,12.5361], desc: "Quartiere vivo e colorato, perfetto per una serata tra bar e murales."},
      {name:"Dar Poeta",type:"Pizzeria",coords:[41.8908,12.4687]},
      {name:"San Lorenzo",type:"Zona",coords:[41.9009,12.5203]},
      {name:"Tiberis",type:"Area estiva",coords:[41.9251,12.4677]},
    ]
  }
];

/* ---------- RENDER CARDS ---------- */
const cardsEl=document.getElementById('cards');
function cardHtml(m){
  const stars='‚òÖ'.repeat(Math.floor(m.rating||0))+'‚òÜ'.repeat(5-Math.floor(m.rating||0));
  return `<article class="card" onclick="openModal('${m.id}')">
    <img class="cover" src="${m.cover}" alt="${m.title}">
    <div class="price-badge">${m.price}‚Ç¨</div>
    <div class="card-body">
      <h3 class="name">${m.title}</h3>
      <div class="rating" style="color:#f5b50a;font-size:13px;">${stars}</div>
      <p class="subtitle">${m.subtitle}</p>
      <div class="chips">${m.keywords.map(k=>`<span class="pill">${k}</span>`).join('')}</div>
    </div></article>`;
}
function renderCards(){
  const mi = MAPS.filter(x=>x.city==="Milano");
  const rm = MAPS.filter(x=>x.city==="Roma");
  cardsEl.innerHTML = `
    <h2 class="section-title">Milano</h2>
    <div class="grid">${mi.map(cardHtml).join('')}</div>
    <h2 class="section-title">Roma</h2>
    <div class="grid">${rm.map(cardHtml).join('')}</div>`;
}
renderCards();
updateGlobalCounters();

/* ---------- MODAL + MAP ---------- */
const modal=document.getElementById('modal');
const modalTitle=document.getElementById('modalTitle');
const modalSubtitle=document.getElementById('modalSubtitle');
const modalCover=document.getElementById('modalCover');
const modalAbout=document.getElementById('modalAbout');
const keywordsBox=document.getElementById('keywords');
const unlockForm=document.getElementById('unlockForm');
const emailInput=document.getElementById('email');
const mapWrap=document.getElementById('mapWrap');
let current=null,mapInstance=null,markers=[];

function openModal(id){
  current = MAPS.find(x => x.id === id);
  modalTitle.textContent = current.title;
  modalSubtitle.textContent = current.subtitle;
  modalCover.src = current.cover;
  modalCover.style.display = 'none';
  modalAbout.textContent = current.about;
  keywordsBox.innerHTML = "";
  current.keywords.forEach(k=>{
    const el=document.createElement('div');
    el.className='keyword'; el.textContent=k;
    el.onclick=()=>el.classList.toggle('active');
    keywordsBox.appendChild(el);
  });

  // Aggiorna prezzo
  const mapPriceEl = document.getElementById('priceInfo');
  const freeMaps = getMapTokens();
  if (freeMaps > 0) {
    mapPriceEl.innerHTML = `<span style="text-decoration:line-through;opacity:0.7;">${current.price}‚Ç¨</span> <span style="color:green;font-weight:700;">Gratis</span>`;
  } else {
    mapPriceEl.innerHTML = `<span style="font-weight:600;color:var(--accent);">${current.price}‚Ç¨</span>`;
  }

  // ‚ö†Ô∏è Mostra SUBITO il modale (importante per iOS)
  modal.style.display = 'grid';

  const unlocked = JSON.parse(localStorage.getItem('unlockedMaps') || '[]');
  if (unlocked.includes(current.id)) {
    unlockForm.style.display = 'none';
    mapWrap.style.display = 'flex';
    showMap(); // ora la mappa parte con contenitore visibile
  } else {
    unlockForm.style.display = 'grid';
    mapWrap.style.display = 'none';
  }

  document.getElementById('chatControls').style.display = 'flex';
  updateChatUI();
}

function closeModal(){modal.style.display='none';modalCover.style.display='block';}
document.getElementById('modalClose').addEventListener('click',closeModal);

/* ---------- MAP + PLACE INFO ---------- */
async function showMap() {
  const unlocked = JSON.parse(localStorage.getItem('unlockedMaps') || '[]');
  if (!unlocked.includes(current.id)) {
    unlocked.push(current.id);
    localStorage.setItem('unlockedMaps', JSON.stringify(unlocked));
  }

  // 1Ô∏è‚É£ Mostra il contenitore PRIMA
  mapWrap.style.display = 'block';  // <-- non "flex", iOS gestisce meglio
  const mapEl = document.getElementById('map');
  mapEl.style.display = 'block';
  mapEl.style.minHeight = '280px';  // sicurezza extra

  // 2Ô∏è‚É£ Se esiste gi√† una mappa, la resetti
  if (mapInstance) {
    try { mapInstance.remove(); } catch (e) {}
    mapInstance = null;
  }

  // 3Ô∏è‚É£ Piccolo delay per far ridisegnare il layout
  await new Promise(r => setTimeout(r, 50));

  // 4Ô∏è‚É£ Crea la mappa
  mapInstance = L.map(mapEl, { tap: false });
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(mapInstance);

  // 5Ô∏è‚É£ Forza resize multiplo (compat iOS)
  setTimeout(() => mapInstance.invalidateSize(), 100);
  setTimeout(() => mapInstance.invalidateSize(), 400);
  setTimeout(() => mapInstance.invalidateSize(), 800);

  // 6Ô∏è‚É£ Centra e aggiungi marker
  mapInstance.setView(current.center, 13);
  markers.forEach(m => m.remove());
  markers = [];

  current.poi.forEach(p => {
    const mk = L.marker(p.coords).addTo(mapInstance);
    mk.bindPopup(`<b>${p.name}</b><br><small>${p.type || ''}</small>`);
    mk.on('click', () => showPlaceInfo(p));
    markers.push(mk);
  });
}

function showPlaceInfo(p){
  const info=document.getElementById('placeInfo');
  document.getElementById('placeTitle').textContent=p.name||'';
  document.getElementById('placeType').textContent=p.type||'';
  document.getElementById('placeDesc').textContent=p.desc||'Nessuna descrizione disponibile.';
  const q=encodeURIComponent(p.name+' '+(current?current.city:''));
  const googleA=document.getElementById('placeGoogle');
  googleA.href=`https://www.google.com/maps?q=${q}`;
  googleA.onclick=()=>trackEvent({event:'google_maps_click',mapId:current.id,city:current.city,place:p.name});
  info.style.display='block';
}
document.getElementById('closePlaceInfo').addEventListener('click',()=>document.getElementById('placeInfo').style.display='none');

/* ---------- UNLOCK FORM ---------- */
unlockForm.addEventListener('submit', async e => {
  e.preventDefault();
  const email = emailInput.value.trim();
  if (!email) {
    alert("Inserisci un'email valida");
    return;
  }

  await fetch(SUBMIT_ENDPOINT, {
    method: 'POST', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      event: 'unlock_map', email, mapId: current.id, city: current.city,
      priceSelected: current.price,
      interests: Array.from(document.querySelectorAll('.keyword.active')).map(x => x.textContent)
    })
  }).catch(() => {});

  let remainingMaps = getMapTokens();

  if (!hasSubscription()) {
    if (remainingMaps > 0) {
      remainingMaps--;
      setMapTokens(remainingMaps);
      showMap();
      unlockForm.style.display = 'none';
      if (remainingMaps === 0) {
        if (!localStorage.getItem('subscription_modal_shown')) {
          setTimeout(() => {
            alert("Hai esaurito gli sblocchi gratuiti. Scopri le opzioni di abbonamento, oppure acquista le mappe singolarmente!");
            openSubscriptionModal();
            localStorage.setItem('subscription_modal_shown', '1');
          }, 100);
        } else {
          setTimeout(() => {
            alert("Hai esaurito gli sblocchi gratuiti. Puoi continuare a esplorare acquistando mappe singole.");
          }, 100);
        }
      }
    } else {
      // Crediti terminati ‚Üí sblocco ma al prezzo pieno
      showMap();
      unlockForm.style.display = 'none';
    }
  } else {
    showMap();
    unlockForm.style.display = 'none';
  }

  document.getElementById('chatControls').style.display = 'flex';
  scheduleFeedback(current.id, email);
});

/* ---------- CHAT ---------- */
document.getElementById('startChat').addEventListener('click',()=>{
  if (!hasSubscription()) {
    let tokens = getChatTokens();
    if (tokens <= 0) {
      alert('Hai esaurito le chat gratuite. Scopri le opzioni di abbonamento!');
      openSubscriptionModal();
      return;
    }
    tokens--;
    setChatTokens(tokens);
  }
  trackEvent({event:'chat_attempt',mapId:current.id,city:current.city});
  alert('La chat con il Local non √® ancora disponibile, ma sar√† aggiunta presto!');
});

/* ---------- FEEDBACK ---------- */
function buildFeedbackUrl(mapId,email){
  const u=new URL(FEEDBACK_FORM);
  u.searchParams.set("mapId",mapId);
  u.searchParams.set("email",email||"");
  return u.toString();
}
function scheduleFeedback(mapId,email){
  const k=`feedback_shown:${mapId}`;
  if(localStorage.getItem(k))return;
  setTimeout(()=>{
    const toast=document.getElementById('feedbackToast');
    const link=document.getElementById('feedbackLink');
    const close=document.getElementById('feedbackClose');
    link.href=buildFeedbackUrl(mapId,email);
    toast.style.display='flex';
    close.onclick=()=>{toast.style.display='none';localStorage.setItem(k,'1');};
  },FEEDBACK_DELAY_MS);
}

/* ---------- TUTORIAL ---------- */
const tutorialSteps = [
  "Benvenuto su Locals! üéâ Hai 1 mappa e 1 chat gratuite per iniziare.",
  "Guarda in alto üîù per vedere quanti sblocchi ti restano.",
  "Per sbloccare una mappa inserisci la tua email. Tutto √® gratuito e senza addebiti!"
];
let currentStep = 0;

function startTutorial(){
  if(localStorage.getItem('tutorial_seen')) return;
  const overlay = document.getElementById('tutorialOverlay');
  const stepBox = document.getElementById('tutorialStep');
  const nextBtn = document.getElementById('tutorialNext');

  overlay.style.display = 'flex';
  stepBox.textContent = tutorialSteps[currentStep];
  nextBtn.onclick = () => {
    currentStep++;
    if(currentStep < tutorialSteps.length){
      stepBox.textContent = tutorialSteps[currentStep];
    } else {
      overlay.style.display = 'none';
      localStorage.setItem('tutorial_seen','1');
    }
  };
}
window.addEventListener('load', startTutorial);  

/* ---------- SUBSCRIPTION MODAL ---------- */
function openSubscriptionModal(){
  document.getElementById('subscriptionModal').style.display='flex';
}
function closeSubscriptionModal(){
  document.getElementById('subscriptionModal').style.display='none';
}
function selectPlan(plan){
  if (plan === 'pacchetto') {
    setChatTokens(getChatTokens() + 5);
    alert('Hai ottenuto 5 chat aggiuntive! üéâ');
  } else if (plan === 'mensile') {
    activateSubscription();
    alert('Abbonamento mensile attivato! Ora hai accesso illimitato a mappe e chat.');
  }

  trackEvent({event:'select_plan',plan});
  closeSubscriptionModal();
}

/* ---------- DEBUG / RESET ---------- */
function fullResetLocalsApp() {
  try {
    localStorage.clear();
    sessionStorage.clear();
    if ('caches' in window) {
      caches.keys().then(keys => keys.forEach(k => caches.delete(k)));
    }
    alert("‚úÖ Tutto resettato! Ricarica la pagina per ripartire da zero.");
  } catch (err) {
    alert("Errore nel reset: " + err.message);
  }
}

window.onerror = (msg, src, line, col, err) => {
  alert("‚ö†Ô∏è Errore JS:\n" + msg + "\n" + src + ":" + line);
};
</script>

<!-- Subscription modal -->
<div id="subscriptionModal" style="
  position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;
  align-items:center;justify-content:center;z-index:350;">
  <div style="background:#fff;border-radius:14px;padding:24px;max-width:420px;width:90%;text-align:center;">
    <h2 style="color:var(--accent);margin-top:0;">Sblocca pi√π mappe e chat</h2>
    <p style="font-size:14px;color:#666;margin-bottom:20px;">
      Scegli un piano per continuare a esplorare e chattare con i Local.<br>
    </p>

    <div style="display:flex;flex-direction:column;gap:12px;margin-bottom:20px;">
      <button onclick="selectPlan('pacchetto')" class="btn btn-primary">
        üí¨ Pacchetto 5 chat aggiuntive ‚Äì 4,99‚Ç¨*
      </button>
      <button onclick="selectPlan('mensile')" class="btn btn-primary">
        üåç Abbonamento mensile ‚Äì accesso illimitato ‚Äì 9,99‚Ç¨*
      </button>
    </div>

    <div style="font-size:13px;color:#444;font-weight:600;margin-top:4px;">
      * Nessun addebito reale
    </div>
      <button onclick="closeSubscriptionModal()" 
        style="background:#f4f3ff;border:1px solid var(--border);
               color:var(--accent);font-weight:700;padding:8px 14px;
               border-radius:10px;cursor:pointer;transition:all .2s;">
        ‚úï Chiudi
      </button>
  </div>
</div>

<!-- Feedback toast -->
<div id="feedbackToast" style="position:fixed;left:16px;right:16px;bottom:16px;z-index:200;
display:none;gap:10px;align-items:center;justify-content:space-between;
background:#1e1b2c;color:#fff;border:1px solid #444;padding:14px 16px;
border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,0.25);">
  <div style="font-size:15px">Ti va di dirci com‚Äô√® andata? Basta 1 minuto üôè</div>
  <div style="display:flex;gap:8px">
    <a id="feedbackLink" target="_blank" rel="noopener"
       style="background:var(--accent);color:#fff;border:none;padding:8px 12px;
       border-radius:10px;font-weight:600;text-decoration:none;">Apri questionario</a>
    <button id="feedbackClose"
      style="background:transparent;color:#fff;border:1px solid #777;
      padding:8px 12px;border-radius:10px;cursor:pointer;
      font-weight:600;font-size:14px;text-decoration:none;">
      Pi√π tardi
    </button>
  </div>
</div>

<!-- Tutorial overlay -->
<div id="tutorialOverlay" style="
  position:fixed;inset:0;background:rgba(0,0,0,0.85);color:#fff;
  display:none;flex-direction:column;align-items:center;justify-content:center;
  text-align:center;z-index:400;padding:24px;">
  <div id="tutorialStep" style="max-width:400px;font-size:18px;line-height:1.6;"></div>
  <button id="tutorialNext" class="btn btn-primary" style="margin-top:20px;">Avanti</button>
</div>

<!-- Bottone reset temporaneo -->
<button onclick="fullResetLocalsApp()" 
  style="position:fixed;bottom:10px;left:10px;z-index:9999;
         background:#e53935;color:#fff;border:none;
         padding:8px 12px;border-radius:8px;font-weight:600;">
  üîÑ Reset
</button>
  
</body>
</html>
